<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Phenotype Disease Image Database | PDIDB</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Merriweather:wght@300;400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

  <style>
    :root {
      --primary-color: #0f172a;   
      --accent-color: #334155;     
      --highlight-color: #2563eb;  
      --bg-color: #f8f9fa;         
      --card-bg: #ffffff;
      --border-color: #e2e8f0;
      --text-primary: #1e293b;
      --text-secondary: #64748b;
      --like-color: #e11d48;
      --gold-color: #f59e0b; 
      
      --font-heading: 'Merriweather', serif;
      --font-body: 'Inter', sans-serif;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: var(--font-body);
      background: var(--bg-color);
      color: var(--text-primary);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
    }

    /* === Tooltip Styling === */
    .info-wrapper {
        display: inline-block; position: relative; margin-left: 6px; cursor: help;
    }
    .info-icon {
        display: inline-flex; align-items: center; justify-content: center;
        width: 15px; height: 15px; border-radius: 50%;
        background: var(--text-secondary); color: white;
        font-size: 9px; font-family: sans-serif; font-weight: bold;
    }
    .tooltip-content {
        visibility: hidden; opacity: 0; width: 240px; background-color: #1e293b; color: #fff;
        text-align: left; border-radius: 6px; padding: 10px; position: absolute; z-index: 1000;
        bottom: 135%; left: 50%; margin-left: -120px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.2);
        font-size: 0.75rem; line-height: 1.4; font-weight: 400; transition: opacity 0.2s; pointer-events: none;
        text-transform: none;
    }
    .tooltip-content::after {
        content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px;
        border-width: 5px; border-style: solid; border-color: #1e293b transparent transparent transparent;
    }
    .info-wrapper:hover .tooltip-content { visibility: visible; opacity: 1; }

    /* === Gold Badge === */
    .gold-badge {
        position: absolute; top: 0; right: 0;
        background: linear-gradient(135deg, #fcd34d 0%, #f59e0b 100%);
        color: #78350f; font-size: 0.65rem; font-weight: 700; padding: 5px 10px;
        border-bottom-left-radius: 8px; z-index: 15; box-shadow: -2px 2px 4px rgba(0,0,0,0.1);
        display: flex; align-items: center; gap: 4px; text-transform: uppercase; letter-spacing: 0.5px;
    }

    /* === Layout Components === */
    .header {
      background: var(--card-bg); 
      border-bottom: 1px solid var(--border-color);
      padding: 25px 40px; 
      display: flex; 
      align-items: center; 
      
      justify-content: center;  
      text-align: center;       
    }
    .header-content { max-width: 1600px; margin: 0 auto; width: 100%; }
    .header h1 { font-family: var(--font-heading); font-size: 1.6rem; font-weight: 700; color: var(--primary-color); }
    .header-subtitle { font-size: 0.9rem; color: var(--text-secondary); margin-top: 4px; }

    .container { max-width: 1600px; margin: 30px auto; padding: 0 40px; }

    /* === Filter Section (Optimized Layout) === */
    .filter-section {
      background: var(--card-bg); padding: 25px; border: 1px solid var(--border-color);
      border-radius: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); margin-bottom: 25px;
    }
    .section-header { 
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; 
    }
    .section-title { font-family: var(--font-heading); font-size: 1.1rem; color: var(--primary-color); font-weight: 700; }

    /* Flexbox Filters: Allows items to fit on one line better than grid */
    .filters { 
      display: flex; 
      flex-wrap: wrap; 
      gap: 15px; 
      align-items: flex-end;
    }
    
    .filter-group { 
      display: flex; flex-direction: column; 
      flex: 1 1 140px; /* Grow, Shrink, Basis */
      min-width: 140px; /* Don't get too small */
    }
    
    /* Make Pathology slightly wider as the primary filter */
    .filter-group:first-child { flex: 2 1 200px; }

    .filter-group label { 
      font-size: 0.7rem; font-weight: 600; color: var(--text-secondary); 
      margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;
      display: flex; align-items: center;
    }

    .filter-group select {
      padding: 10px 12px; border: 1px solid var(--border-color); border-radius: 6px;
      font-size: 0.85rem; font-family: var(--font-body); background: #fff;
      color: var(--text-primary); cursor: pointer; transition: all 0.2s;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05); width: 100%;
      text-overflow: ellipsis; white-space: nowrap; overflow: hidden;
    }
    .filter-group select:focus {
        outline: none; border-color: var(--highlight-color); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    /* === Action Bar === */
    .action-bar {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 20px; padding: 12px 20px; background: #fff; 
      border: 1px solid var(--highlight-color); border-radius: 8px; 
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
      position: sticky; top: 10px; z-index: 100;
    }
    .stats-text { font-size: 0.85rem; color: var(--text-secondary); }
    .stats-text .number { font-weight: 600; color: var(--primary-color); }
    
    .selection-controls { display: flex; gap: 10px; align-items: center; }
    .btn-secondary { background: white; color: var(--text-secondary); border: 1px solid var(--border-color); padding: 8px 14px; border-radius: 6px; cursor: pointer; transition: all 0.2s; font-size: 0.85rem;}
    .btn-secondary:hover { background: #f8fafc; color: var(--text-primary); border-color: #cbd5e1; }
    
    .btn-download-zip { 
      background: var(--highlight-color); color: white; font-weight: 600;
      padding: 8px 14px; border-radius: 6px; border: none; cursor: pointer;
      display: flex; align-items: center; gap: 6px; transition: background 0.2s; font-size: 0.85rem;
    }
    .btn-download-zip:hover { background: #1d4ed8; }
    .btn-download-zip:disabled { background: #94a3b8; cursor: not-allowed; }

    /* === Gallery === */
    .gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 20px; }

    .image-card {
      background: var(--card-bg); border: 2px solid var(--border-color);
      border-radius: 8px; overflow: hidden; transition: all 0.2s; cursor: pointer; position: relative;
    }
    .image-card:hover { transform: translateY(-3px); border-color: #cbd5e1; box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.1); }
    .image-card.selected { border-color: var(--highlight-color); background-color: #eff6ff; }
    .image-card.selected::after {
      content: "âœ“"; position: absolute; top: 10px; left: 10px;
      background: var(--highlight-color); color: white; width: 24px; height: 24px;
      border-radius: 50%; display: flex; align-items: center; justify-content: center;
      font-size: 14px; font-weight: bold; z-index: 20; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .card-click-area { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 5; }

    .image-info { padding: 14px; border-top: 1px solid var(--border-color); background: white; position: relative; z-index: 6; }
    .image-id { font-family: 'Roboto Mono', monospace; font-size: 0.7rem; color: var(--text-secondary); display: block; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; margin-bottom: 8px; }

    .metadata-pill { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 0.65rem; font-weight: 600; margin-right: 4px; margin-bottom: 0; letter-spacing: 0.3px; }
    .pill-verification-high { background: #dcfce7; color: #166534; }
    .pill-verification-clinician { background: #fffbeb; color: #92400e; border: 1px solid #fcd34d; }
    .pill-verification-medium { background: #e0f2fe; color: #0369a1; }
    .pill-verification-low { background: #fee2e2; color: #991b1b; }
    .pill-model { background: #f1f5f9; color: #475569; border: 1px solid #e2e8f0; }

    .card-stats { display: flex; justify-content: space-between; margin-top: 12px; padding-top: 8px; border-top: 1px solid #f1f5f9; font-size: 0.75rem; color: #94a3b8; }
    .stat-item.liked { color: var(--like-color); }

    /* === Modal === */
    .modal {
      display: none; position: fixed; z-index: 3000; left: 0; top: 0; width: 100%; height: 100%;
      background: rgba(15, 23, 42, 0.85); backdrop-filter: blur(4px);
      align-items: center; justify-content: center;
    }
    .modal-content {
      background: white; width: 1000px; max-width: 95vw; max-height: 90vh;
      border-radius: 12px; display: flex; flex-direction: column; overflow: hidden;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    }
    .modal-body { padding: 0; display: grid; grid-template-columns: 45% 55%; overflow-y: auto; height: 100%; }
    .modal-img-wrapper { background: #f1f5f9; display: flex; align-items: center; justify-content: center; padding: 20px; border-right: 1px solid #e2e8f0; }
    .modal-img-wrapper img { max-width: 100%; max-height: 60vh; border-radius: 8px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
    .modal-details-panel { padding: 35px; }
    
    .detail-table { width: 100%; border-collapse: collapse; margin: 25px 0; }
    .detail-table tr { border-bottom: 1px solid var(--border-color); }
    .detail-table td { padding: 14px 0; font-size: 0.9rem; }
    .detail-table .detail-label { font-weight: 600; color: var(--text-secondary); width: 40%; }

    .btn-vote { background: white; border: 1px solid #fda4af; color: var(--like-color); padding: 8px 16px; border-radius: 6px; cursor: pointer; transition: all 0.2s; }
    .btn-vote:hover { background: #fff1f2; transform: translateY(-1px); }
    .btn-vote.voted { background: var(--like-color); color: white; }

    /* Loading Overlay */
    .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 4000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    .loader-bar { width: 200px; height: 4px; background: #e2e8f0; border-radius: 2px; margin-top: 15px; overflow: hidden; }
    .loader-progress { width: 0%; height: 100%; background: var(--highlight-color); transition: width 0.3s; }
  </style>
</head>
<body>

  <div id="loading-screen" class="loading-overlay">
      <h3 style="color:var(--primary-color);">Loading Database...</h3>
      <div class="loader-bar"><div class="loader-progress" id="progress-bar"></div></div>
  </div>

  <div class="header">
    <div class="header-content">
      <h1>Phenotype Disease Image Database (PDIDB)</h1>
      <div class="header-subtitle">A Webpage of Synthetic Phenotypic Representations for Clinical Research</div>
    </div>
  </div>

  <div class="container">
    <div class="filter-section">
      <div class="section-header">
        <h2 class="section-title">Database Query</h2>
        <button class="btn-secondary" onclick="resetFilters()" style="font-size: 0.8rem;">Reset Filters</button>
      </div>
      
      <div class="filters">
        <div class="filter-group">
          <label for="disease">Pathology</label>
          <select id="disease" onchange="applyFilters()">
            <option value="">All Pathologies</option>
            <option value="CdLS">Cornelia de Lange Syndrome</option>
            <option value="WBS">Williams-Beuren Syndrome</option>
            <option value="NS">Noonan Syndrome</option>
            <option value="KS">Kabuki Syndrome</option>
            <option value="KBGS">KBG Syndrome</option>
            <option value="AS">Angelman Syndrome</option>
            <option value="RTS">Rubinstein-Taybi Syndrome</option>
            <option value="SMS">Smith-Magenis Syndrome</option>
            <option value="NCBRS">Nicolaides-Baraitser Syndrome</option>
            <option value="22q">22q11.2 Deletion Syndrome</option>
          </select>
        </div>

        <div class="filter-group">
            <label for="gender">Biological Sex</label>
            <select id="gender" onchange="applyFilters()">
              <option value="">All</option>
              <option value="Male">Male</option>
              <option value="Female">Female</option>
              <option value="Unknown">Unknown</option>
            </select>
        </div>

        <div class="filter-group">
            <label for="age">Age Group</label>
            <select id="age" onchange="applyFilters()">
              <option value="">All Ages</option>
              <option value="0-2">Infant (0-2)</option>
              <option value="3-6">Early Childhood (3-6)</option>
              <option value="7-9">Middle Childhood (7-9)</option>
              <option value="10-14">Adolescence (10-14)</option>
              <option value="15+">Adult (15+)</option>
              <option value="Unknown">Unknown</option>
            </select>
        </div>

        <div class="filter-group">
          <label for="ancestry">Ancestry / Race</label>
          <select id="ancestry" onchange="applyFilters()">
            <option value="">All Groups</option>
            <option value="European">European</option>
            <option value="African">African</option>
            <option value="Asian">Asian</option>
            <option value="Latino">Latino</option>
            <option value="Multi-ancestry">Multi-ancestry</option>
            <option value="Unknown">Unknown</option>
          </select>
        </div>

        <div class="filter-group">
          <label for="verification">
              Verification
              <div class="info-wrapper">
                  <span class="info-icon">i</span>
                  <div class="tooltip-content">
                      <strong>Verification Levels:</strong><br>
                      Clinician: Verified by medical geneticists.<br>
                      High/Medium/Low: Computational confidence scores by our MARDD model.
                  </div>
              </div>
          </label>
          <select id="verification" onchange="applyFilters()">
            <option value="">All Levels</option>
            <option value="clinician">Clinician Verified</option>
            <option value="high">High</option>
            <option value="medium">Medium</option>
            <option value="low">Low</option>
          </select>
        </div>

        <div class="filter-group">
          <label for="model">
              Gen. Model
              <div class="info-wrapper">
                  <span class="info-icon">i</span>
                  <div class="tooltip-content">
                      <strong>Model Info:</strong><br>
                      v1: Trained on the GMDB dataset, with FFHQ as the healthy cohort.<br>
                      v2: Trained on the manually filtered GMDB dataset, with FairFace as the healthy cohort.
                  </div>
              </div>
          </label>
          <select id="model" onchange="applyFilters()">
            <option value="">All Versions</option>
            <option value="v1">StyleGAN3 v1</option>
            <option value="v2">StyleGAN3 v2</option>
          </select>
        </div>
      </div>
    </div>

    <div class="action-bar">
      <div class="stats-text">
        Showing <span class="number" id="result-count">0</span> records. 
        Selected: <span class="number" id="selection-count">0</span>
      </div>
      
      <div class="selection-controls">
        <button class="btn-secondary" onclick="selectAllVisible()">Select Page</button>
        <button class="btn-secondary" onclick="clearSelection()">Deselect All</button>
        <button class="btn-download-zip" id="dl-btn" onclick="downloadSelectedItems()" disabled>
          <div class="spinner" id="dl-spinner" style="border: 2px solid rgba(255,255,255,0.3); border-top: 2px solid #fff; width:12px; height:12px; border-radius:50%; animation:spin 1s linear infinite; display:none; margin-right:5px;"></div>
          <span id="dl-text"><i class="fa-solid fa-file-zipper"></i> Download ZIP</span>
        </button>
      </div>
    </div>

    <div id="gallery" class="gallery"></div>
  </div>

  <div class="footer" style="text-align:center; padding:40px; color:var(--text-secondary); border-top:1px solid var(--border-color); margin-top:40px;">
    <p>&copy; 2025 Wang Genomics Laboratory, Children's Hospital of Philadelphia.</p>
  </div>

  <div id="modal" class="modal" onclick="closeModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-header" style="padding:20px 30px; border-bottom:1px solid var(--border-color); display:flex; justify-content:space-between; align-items:center;">
        <h2 id="modal-title" style="font-family: var(--font-heading); color: var(--primary-color);">Details</h2>
        <span onclick="closeModal()" style="font-size:28px; cursor:pointer; color:var(--text-secondary);">&times;</span>
      </div>
      <div class="modal-body" id="modal-body-content"></div>
    </div>
  </div>

  <script>
    // ===== CONFIGURATION =====
    const HF_DATASET = "HzChen20/PDIDB";
    const API_BASE = `https://datasets-server.huggingface.co/rows?dataset=${HF_DATASET}&config=default&split=train`;
    
    let rawDatabase = [];
    let selectedIds = new Set();
    let currentlyVisibleImages = [];
    let userVotes = JSON.parse(localStorage.getItem('pdidb_votes')) || {}; 
    let downloadStats = JSON.parse(localStorage.getItem('pdidb_downloads')) || {}; 

    // ===== TEXT EDITING: DEFINITIONS FOR TOOLTIPS =====
    const DESCRIPTIONS = {
        model_v1: "Trained on the GMDB dataset, with FFHQ as the healthy cohort.", 
        model_v2: "Trained on the manually filtered GMDB dataset, with FairFace as the healthy cohort.", 
        model_unknown: "Model version not specified in metadata.",
        
        verif_clinician: "Verified by medical geneticists.", 
        verif_other: "Verified by our MARDD model."
    }; 

    window.onload = async function() { await fetchAllData(); };

    // 1. DATA FETCHING & NORMALIZATION
    async function fetchAllData() {
        const loadingScreen = document.getElementById('loading-screen');
        const progressBar = document.getElementById('progress-bar');
        
        try {
            let allRows = [];
            let offset = 0;
            let length = 100;
            let keepFetching = true;

            // Fetch up to 2500 rows
            while(keepFetching && offset < 2500) {
                const response = await fetch(`${API_BASE}&offset=${offset}&length=${length}`);
                if(!response.ok) throw new Error("HF API Error");
                const data = await response.json();
                
                if(!data.rows || data.rows.length === 0) { keepFetching = false; } 
                else {
                    allRows = [...allRows, ...data.rows];
                    offset += length;
                    progressBar.style.width = `${Math.min((offset/1800)*100, 100)}%`;
                }
            }

            rawDatabase = allRows.map(row => {
                const r = row.row;
                
                // === Base64 Logic Logic ===
                let finalUrl = "";
                if (r.image && r.image.src) {
                    finalUrl = r.image.src;
                } else if (r.image && r.image.bytes) {
                    finalUrl = `data:image/png;base64,${r.image.bytes}`;
                } else if (r.file_name && r.file_name.src) {
                    finalUrl = r.file_name.src;
                } else {
                    finalUrl = "https://placehold.co/400?text=No+Image";
                }

                return {
                    id: r.image_id,
                    url: finalUrl,
                    disease: r.disease_abbr,
                    diseaseFull: r.disease,
                    model: normalizeText(r.model, "v1"),
                    verification: normalizeText(r.verification, "medium"),
                    ancestry: normalizeText(r.race, "Unknown"),
                    gender: normalizeText(r.gender, "Unknown"),
                    age: normalizeText(r.age_range, "Unknown")
                };
            });

            loadingScreen.style.display = 'none';
            applyFilters();

        } catch (error) {
            console.error(error);
            document.querySelector('#loading-screen h3').textContent = "Error Loading Data";
        }
    }

    function normalizeText(txt, fallback = "Unknown") {
        if (!txt) return fallback;
        if (typeof txt === 'string') {
            if (txt.toLowerCase() === "none" || txt.toLowerCase() === "null" || txt.trim() === "") return fallback;
        }
        return txt;
    }

    // 2. FILTERING
    function applyFilters() {
        const fDisease = document.getElementById("disease").value;
        const fModel = document.getElementById("model").value;
        const fVerif = document.getElementById("verification").value;
        const fAncestry = document.getElementById("ancestry").value;
        const fGender = document.getElementById("gender").value;
        const fAge = document.getElementById("age").value;

        const filtered = rawDatabase.filter(item => {
            if (fDisease && item.disease !== fDisease) return false;
            if (fModel && item.model !== fModel) return false;
            if (fVerif && item.verification !== fVerif) return false;
            
            if (fAncestry) {
                if(fAncestry === "Unknown" && item.ancestry !== "Unknown") return false;
                if(fAncestry !== "Unknown" && !item.ancestry.includes(fAncestry)) return false;
            }
            
            if (fGender && item.gender !== fGender) return false;
            if (fAge && item.age !== fAge) return false;
            
            return true;
        });

        displayImages(filtered);
    }

    function resetFilters() {
        document.querySelectorAll('select').forEach(s => s.value = "");
        applyFilters();
    }

    // 3. RENDERING GALLERY (UPDATED: No Race Table)
    function displayImages(images) {
        currentlyVisibleImages = images;
        const gallery = document.getElementById("gallery");
        document.getElementById("result-count").textContent = images.length;

        if (images.length === 0) {
            gallery.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:60px;"><h3>No Results</h3></div>`;
            return;
        }

        gallery.innerHTML = images.map(img => {
            const isVoted = userVotes[img.id] ? 'liked' : '';
            const dlCount = downloadStats[img.id] || 0;
            
            const goldBadge = img.verification === 'clinician' 
                ? `<div class="gold-badge"><i class="fa-solid fa-certificate"></i> Verified</div>` 
                : '';

            return `
            <div class="image-card ${selectedIds.has(img.id) ? 'selected' : ''}" data-id="${img.id}">
                <div class="card-click-area" onclick="toggleSelection('${img.id}')"></div>
                ${goldBadge}
                
                <img src="${img.url}" loading="lazy" 
                     style="width: 100%; height: 260px; object-fit: cover; background: #f1f5f9;"
                     onerror="this.src='https://placehold.co/400?text=Image+Error'">
                
                <div class="image-info">
                    <button class="btn-secondary" style="float:right; padding: 4px 8px; font-size: 0.7rem; position:relative; z-index:20;" 
                            onclick="event.stopPropagation(); showModal('${img.id}')">Details</button>
                    <span class="image-id">${img.id}</span>
                    
                    <div style="margin-bottom: 8px;">
                        <span class="metadata-pill pill-model">${img.model}</span>
                        <span class="metadata-pill pill-verification-${img.verification}">${img.verification}</span>
                    </div>

                    <div class="card-stats">
                        <span class="stat-item ${isVoted}"><i class="fa-${isVoted ? 'solid' : 'regular'} fa-heart"></i></span>
                        <span class="stat-item"><i class="fa-solid fa-download"></i> ${dlCount}</span>
                    </div>
                </div>
            </div>`;
        }).join("");
        renderSelectionState();
    }

    // 4. SELECTION & FEATURES
    function toggleSelection(id) {
        if (selectedIds.has(id)) selectedIds.delete(id); else selectedIds.add(id);
        renderSelectionState();
    }
    function selectAllVisible() {
        currentlyVisibleImages.forEach(img => selectedIds.add(img.id));
        renderSelectionState();
    }
    function clearSelection() { selectedIds.clear(); renderSelectionState(); }
    function renderSelectionState() {
        document.getElementById("selection-count").textContent = selectedIds.size;
        document.getElementById("dl-btn").disabled = selectedIds.size === 0;
        document.querySelectorAll('.image-card').forEach(card => {
            const id = card.getAttribute('data-id');
            if(selectedIds.has(id)) card.classList.add('selected'); else card.classList.remove('selected');
        });
    }

    function toggleVote(id) {
        if (userVotes[id]) delete userVotes[id]; else userVotes[id] = true;
        localStorage.setItem('pdidb_votes', JSON.stringify(userVotes));
        applyFilters(); 
        const btn = document.getElementById('modal-vote-btn');
        if(btn) updateModalVoteBtn(btn, id);
    }

    // 5. MODAL WITH TOOLTIPS
    function showModal(id) {
        const img = rawDatabase.find(i => i.id === id);
        if(!img) return;

        const modal = document.getElementById("modal");
        const body = document.getElementById("modal-body-content");
        const dlCount = downloadStats[id] || 0;
        const isVoted = !!userVotes[id];

        const modelDesc = img.model === 'v1' ? DESCRIPTIONS.model_v1 : (img.model === 'v2' ? DESCRIPTIONS.model_v2 : DESCRIPTIONS.model_unknown);
        const verifDesc = img.verification === 'clinician' ? DESCRIPTIONS.verif_clinician : DESCRIPTIONS.verif_other;

        body.innerHTML = `
            <div class="modal-img-wrapper">
                <img src="${img.url}">
            </div>
            <div class="modal-details-panel">
                <h3>${img.diseaseFull}</h3>
                <p style="color:var(--text-secondary); font-family:'Roboto Mono'; margin-bottom:20px;">${img.id}</p>

                <div style="background:#f8fafc; padding:15px; border-radius:8px; border:1px solid #e2e8f0; display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <div style="font-size:0.8rem; color:var(--text-secondary);">Downloads</div>
                        <div style="font-size:1.2rem; font-weight:700; color:var(--primary-color);">${dlCount}</div>
                    </div>
                    <button id="modal-vote-btn" class="btn-vote ${isVoted ? 'voted' : ''}" onclick="toggleVote('${img.id}')">
                        <i class="fa-${isVoted ? 'solid' : 'regular'} fa-heart"></i> ${isVoted ? 'Voted' : 'Vote'}
                    </button>
                </div>

                <table class="detail-table">
                    <tr>
                        <td class="detail-label">Generation Model</td>
                        <td>
                            ${img.model} 
                            <div class="info-wrapper">
                                <span class="info-icon">i</span>
                                <div class="tooltip-content">${modelDesc}</div>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td class="detail-label">Verification</td>
                        <td>
                            <span class="metadata-pill pill-verification-${img.verification}">${img.verification}</span>
                            <div class="info-wrapper">
                                <span class="info-icon">i</span>
                                <div class="tooltip-content">${verifDesc}</div>
                            </div>
                        </td>
                    </tr>
                    <tr><td class="detail-label">Ancestry</td><td>${img.ancestry}</td></tr>
                    <tr><td class="detail-label">Sex</td><td>${img.gender}</td></tr>
                    <tr><td class="detail-label">Age</td><td>${img.age}</td></tr>
                </table>
            </div>
        `;
        modal.style.display = 'flex';
    }

    function updateModalVoteBtn(btn, id) {
        const isVoted = !!userVotes[id];
        btn.className = `btn-vote ${isVoted ? 'voted' : ''}`;
        btn.innerHTML = `<i class="fa-${isVoted ? 'solid' : 'regular'} fa-heart"></i> ${isVoted ? 'Voted' : 'Vote'}`;
    }

    function closeModal() {
        document.getElementById("modal").style.display = 'none';
        applyFilters();
    }

    // 6. DOWNLOAD
    async function downloadSelectedItems() {
        if(selectedIds.size === 0) return;
        const btn = document.getElementById("dl-btn");
        const spinner = document.getElementById("dl-spinner");
        
        btn.disabled = true; spinner.style.display = "block";

        try {
            const zip = new JSZip();
            const selectedImages = rawDatabase.filter(i => selectedIds.has(i.id));

            let csv = "image_id,disease,model,verification,race,gender,age,url\n";
            selectedImages.forEach(img => {
                csv += `${img.id},${img.diseaseFull},${img.model},${img.verification},${img.ancestry},${img.gender},${img.age},${img.url}\n`;
                const count = (downloadStats[img.id] || 0) + 1;
                downloadStats[img.id] = count;
            });
            localStorage.setItem('pdidb_downloads', JSON.stringify(downloadStats));
            zip.file("pdidb_metadata.csv", csv);

            const imgFolder = zip.folder("images");
            const promises = selectedImages.map(async (img) => {
                try {
                    // Fetch blob (Supports both http URL and Base64 Data URI)
                    const response = await fetch(img.url);
                    const blob = await response.blob();
                    imgFolder.file(`${img.id}.png`, blob);
                } catch (e) { console.error(e); }
            });

            await Promise.all(promises);
            const content = await zip.generateAsync({type:"blob"});
            saveAs(content, "PDIDB_selected.zip");
            applyFilters();

        } catch (err) { alert("Download failed"); } 
        finally { btn.disabled = false; spinner.style.display = "none"; }
    }
  </script>
</body>
</html>